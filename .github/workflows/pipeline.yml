name: CI-BackEnd

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

jobs:
  build:
    name: Build e Testes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3
      
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Build Maven
        run: |
          cd CRUD
          mvn clean install
      
      - name: Executar Testes
        run: |
          cd CRUD
          mvn test
      
      - name: Upload RelatÃ³rios de Teste
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: CRUD/target/surefire-reports/
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: crud-target
          path: CRUD/target

  sonar:
    name: AnÃ¡lise SonarCloud
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3
      
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: crud-target
          path: CRUD/target
      
      - name: Build para Sonar
        run: |
          cd CRUD
          mvn verify -DskipTests
      
      - name: SonarCloud Scan
        run: |
          cd CRUD
          mvn sonar:sonar \
              -Dsonar.projectKey=Grupo-3-3ADSC_CogniFlow-Backend \
              -Dsonar.organization=grupo-3-3adsc \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
              -Dsonar.java.binaries=target/classes

  deploy:
    name: Deploy para AWS
    runs-on: ubuntu-latest
    needs: [build, sonar]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3
      
      - name: Configurar chaves SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BASTION_SSH_KEY }}" > ~/.ssh/bastion_key
          echo "${{ secrets.PRIVATE_SSH_KEY }}" > ~/.ssh/private_key
          chmod 600 ~/.ssh/bastion_key
          chmod 600 ~/.ssh/private_key
          
          # Configurar SSH config para usar jump host
          cat >> ~/.ssh/config <<EOF
          Host bastion
            HostName ${{ secrets.BASTION_HOST }}
            User ubuntu
            IdentityFile ~/.ssh/bastion_key
            StrictHostKeyChecking no
          
          Host private-instance
            HostName ${{ secrets.PRIVATE_HOST }}
            User ubuntu
            IdentityFile ~/.ssh/private_key
            ProxyJump bastion
            StrictHostKeyChecking no
          EOF
      
      - name: Deploy via Jump Host
        run: |
          ssh private-instance << 'ENDSSH'
            set -e
            echo "ðŸ”„ Atualizando repositÃ³rios..."
            
            cd ~/CogniFlow-Backend/CRUD
            git pull origin develop
            
            cd ~/microservico-verificacao-de-senha
            git pull origin develop
            
            echo "ðŸ³ Reconstruindo containers..."
            cd ~/CogniFlow-Backend/CRUD
            docker compose down
            docker compose build
            docker compose up -d
            
            echo "âœ… Deploy concluÃ­do!"
          ENDSSH
