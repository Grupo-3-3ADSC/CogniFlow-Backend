<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/CRUD/src/main/java/sptech/school/CRUD/application/service/transferencia/RealizarTransferenciaService.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/CRUD/src/main/java/sptech/school/CRUD/application/service/transferencia/RealizarTransferenciaService.java" />
              <option name="originalContent" value="package sptech.school.CRUD.application.service.transferencia;&#10;&#10;import jakarta.transaction.Transactional;&#10;import org.springframework.stereotype.Service;&#10;import sptech.school.CRUD.domain.entity.EstoqueModel;&#10;import sptech.school.CRUD.domain.entity.TransferenciaModel;&#10;import sptech.school.CRUD.domain.exception.RecursoNaoEncontradoException;&#10;import sptech.school.CRUD.domain.exception.RequisicaoInvalidaException;&#10;import sptech.school.CRUD.infrastructure.persistence.estoque.EstoqueRepository;&#10;import sptech.school.CRUD.infrastructure.persistence.transferencia.TransferenciaRepository;&#10;import sptech.school.CRUD.interfaces.dto.Transferencia.TransferenciaDto;&#10;import sptech.school.CRUD.interfaces.dto.Transferencia.TransferenciaMapper;&#10;&#10;import java.time.LocalDateTime;&#10;import java.time.temporal.ChronoUnit;&#10;&#10;@Service&#10;public class RealizarTransferenciaService {&#10;&#10;    private final TransferenciaRepository transferenciaRepository;&#10;    private final EstoqueRepository estoqueRepository;&#10;&#10;    public RealizarTransferenciaService(TransferenciaRepository transferenciaRepository,&#10;                                        EstoqueRepository estoqueRepository) {&#10;        this.transferenciaRepository = transferenciaRepository;&#10;        this.estoqueRepository = estoqueRepository;&#10;    }&#10;&#10;    // Realizar uma transferência (fica pendente até ser confirmada)&#10;    @Transactional&#10;    public TransferenciaDto realizarTransferencia(TransferenciaDto dto) {&#10;        String tipoMaterial = dto.getTipoMaterial();&#10;        Integer quantidadeTransferida = dto.getQuantidadeTransferida();&#10;&#10;        if (tipoMaterial == null || tipoMaterial.isBlank()) {&#10;            throw new RequisicaoInvalidaException(&quot;O tipo do material não pode ser nulo ou vazio.&quot;);&#10;        }&#10;        if (quantidadeTransferida == null || quantidadeTransferida &lt;= 0) {&#10;            throw new RequisicaoInvalidaException(&quot;A quantidade transferida deve ser maior que zero.&quot;);&#10;        }&#10;&#10;        // Validar setor&#10;        String setor = dto.getSetor();&#10;        if (setor == null || !setor.matches(&quot;(?i)^(G1|G2|G3|G4)$&quot;)) {&#10;            throw new RequisicaoInvalidaException(&quot;Setor inválido. Use G1, G2, G3 ou G4.&quot;);&#10;        }&#10;&#10;        // Buscar o material no estoque&#10;        EstoqueModel estoque = estoqueRepository.findByTipoMaterial(tipoMaterial)&#10;                .orElseThrow(() -&gt; new RecursoNaoEncontradoException(&quot;Material não encontrado no estoque&quot;));&#10;&#10;        // Verificar se há quantidade suficiente&#10;        if (estoque.getQuantidadeAtual() &lt; quantidadeTransferida) {&#10;            throw new RequisicaoInvalidaException(&quot;Quantidade insuficiente no estoque&quot;);&#10;        }&#10;&#10;        // NÃO mexe no estoque ainda, apenas cria a transferência pendente&#10;        // Criar a transferência como NÃO confirmada&#10;        TransferenciaModel transferencia = new TransferenciaModel();&#10;        transferencia.setEstoque(estoque);&#10;        transferencia.setQuantidadeTransferida(quantidadeTransferida);&#10;        transferencia.setSetor(setor.toUpperCase());&#10;        transferencia.setUltimaMovimentacao(LocalDateTime.now().truncatedTo(ChronoUnit.SECONDS));&#10;        transferencia.setTipoMaterial(tipoMaterial);&#10;        transferencia.setConfirmada(false);&#10;&#10;        // Salvar a transferência&#10;        TransferenciaModel salvo = transferenciaRepository.save(transferencia);&#10;&#10;        // Retornar DTO&#10;        return TransferenciaMapper.toTransferenciaDto(salvo);&#10;    }&#10;&#10;    // Confirmar uma transferência pendente - move do estoque para o setor&#10;    @Transactional&#10;    public TransferenciaDto confirmarTransferencia(Integer transferenciaId) {&#10;        TransferenciaModel transferencia = transferenciaRepository.findById(transferenciaId)&#10;                .orElseThrow(() -&gt; new RecursoNaoEncontradoException(&quot;Transferência não encontrada&quot;));&#10;&#10;        if (transferencia.getConfirmada() != null &amp;&amp; transferencia.getConfirmada()) {&#10;            throw new RequisicaoInvalidaException(&quot;Transferência já foi confirmada&quot;);&#10;        }&#10;&#10;        // Buscar o estoque DIRETAMENTE do banco para garantir dados atualizados&#10;        EstoqueModel estoque = estoqueRepository.findById(transferencia.getEstoque().getId())&#10;                .orElseThrow(() -&gt; new RecursoNaoEncontradoException(&quot;Estoque não encontrado&quot;));&#10;&#10;        Integer quantidadeTransferida = transferencia.getQuantidadeTransferida();&#10;        Integer quantidadeAtual = estoque.getQuantidadeAtual() != null ? estoque.getQuantidadeAtual() : 0;&#10;&#10;        // Verificar se ainda há quantidade suficiente no estoque&#10;        if (quantidadeAtual &lt; quantidadeTransferida) {&#10;            throw new RequisicaoInvalidaException(&quot;Quantidade insuficiente no estoque para confirmar&quot;);&#10;        }&#10;&#10;        // Subtrair da quantidade atual do estoque&#10;        estoque.setQuantidadeAtual(quantidadeAtual - quantidadeTransferida);&#10;&#10;        // Adicionar ao setor correto (G1, G2, G3 ou G4)&#10;        String setor = transferencia.getSetor().toUpperCase();&#10;        switch (setor) {&#10;            case &quot;G1&quot;:&#10;                Integer g1Atual = estoque.getG1() != null ? estoque.getG1() : 0;&#10;                estoque.setG1(g1Atual + quantidadeTransferida);&#10;                break;&#10;            case &quot;G2&quot;:&#10;                Integer g2Atual = estoque.getG2() != null ? estoque.getG2() : 0;&#10;                estoque.setG2(g2Atual + quantidadeTransferida);&#10;                break;&#10;            case &quot;G3&quot;:&#10;                Integer g3Atual = estoque.getG3() != null ? estoque.getG3() : 0;&#10;                estoque.setG3(g3Atual + quantidadeTransferida);&#10;                break;&#10;            case &quot;G4&quot;:&#10;                Integer g4Atual = estoque.getG4() != null ? estoque.getG4() : 0;&#10;                estoque.setG4(g4Atual + quantidadeTransferida);&#10;                break;&#10;            default:&#10;                throw new RequisicaoInvalidaException(&quot;Setor inválido: &quot; + setor);&#10;        }&#10;&#10;        estoque.setUltimaMovimentacao(LocalDateTime.now().truncatedTo(ChronoUnit.SECONDS));&#10;        estoqueRepository.save(estoque);&#10;&#10;        // Marcar transferência como confirmada&#10;        transferencia.setConfirmada(true);&#10;        transferencia.setUltimaMovimentacao(LocalDateTime.now().truncatedTo(ChronoUnit.SECONDS));&#10;        TransferenciaModel salvo = transferenciaRepository.save(transferencia);&#10;&#10;        return TransferenciaMapper.toTransferenciaDto(salvo);&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package sptech.school.CRUD.application.service.transferencia;&#10;&#10;import jakarta.transaction.Transactional;&#10;import org.springframework.stereotype.Service;&#10;import sptech.school.CRUD.domain.entity.EstoqueModel;&#10;import sptech.school.CRUD.domain.entity.TransferenciaModel;&#10;import sptech.school.CRUD.domain.exception.RecursoNaoEncontradoException;&#10;import sptech.school.CRUD.domain.exception.RequisicaoInvalidaException;&#10;import sptech.school.CRUD.infrastructure.persistence.estoque.EstoqueRepository;&#10;import sptech.school.CRUD.infrastructure.persistence.transferencia.TransferenciaRepository;&#10;import sptech.school.CRUD.interfaces.dto.Transferencia.TransferenciaDto;&#10;import sptech.school.CRUD.interfaces.dto.Transferencia.TransferenciaMapper;&#10;&#10;import java.time.LocalDateTime;&#10;import java.time.temporal.ChronoUnit;&#10;&#10;@Service&#10;public class RealizarTransferenciaService {&#10;&#10;    private final TransferenciaRepository transferenciaRepository;&#10;    private final EstoqueRepository estoqueRepository;&#10;&#10;    public RealizarTransferenciaService(TransferenciaRepository transferenciaRepository,&#10;                                        EstoqueRepository estoqueRepository) {&#10;        this.transferenciaRepository = transferenciaRepository;&#10;        this.estoqueRepository = estoqueRepository;&#10;    }&#10;&#10;    // Realizar uma transferência - subtrai da quantidade e adiciona ao setor imediatamente&#10;    @Transactional&#10;    public TransferenciaDto realizarTransferencia(TransferenciaDto dto) {&#10;        String tipoMaterial = dto.getTipoMaterial();&#10;        Integer quantidadeTransferida = dto.getQuantidadeTransferida();&#10;&#10;        if (tipoMaterial == null || tipoMaterial.isBlank()) {&#10;            throw new RequisicaoInvalidaException(&quot;O tipo do material não pode ser nulo ou vazio.&quot;);&#10;        }&#10;        if (quantidadeTransferida == null || quantidadeTransferida &lt;= 0) {&#10;            throw new RequisicaoInvalidaException(&quot;A quantidade transferida deve ser maior que zero.&quot;);&#10;        }&#10;&#10;        // Validar setor&#10;        String setor = dto.getSetor();&#10;        if (setor == null || !setor.matches(&quot;(?i)^(G1|G2|G3|G4)$&quot;)) {&#10;            throw new RequisicaoInvalidaException(&quot;Setor inválido. Use G1, G2, G3 ou G4.&quot;);&#10;        }&#10;&#10;        // Buscar o material no estoque&#10;        EstoqueModel estoque = estoqueRepository.findByTipoMaterial(tipoMaterial)&#10;                .orElseThrow(() -&gt; new RecursoNaoEncontradoException(&quot;Material não encontrado no estoque&quot;));&#10;&#10;        Integer quantidadeAtual = estoque.getQuantidadeAtual() != null ? estoque.getQuantidadeAtual() : 0;&#10;&#10;        // Verificar se há quantidade suficiente&#10;        if (quantidadeAtual &lt; quantidadeTransferida) {&#10;            throw new RequisicaoInvalidaException(&quot;Quantidade insuficiente no estoque&quot;);&#10;        }&#10;&#10;        // SUBTRAIR da quantidade atual do estoque&#10;        estoque.setQuantidadeAtual(quantidadeAtual - quantidadeTransferida);&#10;&#10;        // ADICIONAR ao setor correto (G1, G2, G3 ou G4)&#10;        String setorUpper = setor.toUpperCase();&#10;        switch (setorUpper) {&#10;            case &quot;G1&quot;:&#10;                Integer g1Atual = estoque.getG1() != null ? estoque.getG1() : 0;&#10;                estoque.setG1(g1Atual + quantidadeTransferida);&#10;                break;&#10;            case &quot;G2&quot;:&#10;                Integer g2Atual = estoque.getG2() != null ? estoque.getG2() : 0;&#10;                estoque.setG2(g2Atual + quantidadeTransferida);&#10;                break;&#10;            case &quot;G3&quot;:&#10;                Integer g3Atual = estoque.getG3() != null ? estoque.getG3() : 0;&#10;                estoque.setG3(g3Atual + quantidadeTransferida);&#10;                break;&#10;            case &quot;G4&quot;:&#10;                Integer g4Atual = estoque.getG4() != null ? estoque.getG4() : 0;&#10;                estoque.setG4(g4Atual + quantidadeTransferida);&#10;                break;&#10;            default:&#10;                throw new RequisicaoInvalidaException(&quot;Setor inválido: &quot; + setorUpper);&#10;        }&#10;&#10;        estoque.setUltimaMovimentacao(LocalDateTime.now().truncatedTo(ChronoUnit.SECONDS));&#10;        estoqueRepository.save(estoque);&#10;&#10;        // Criar a transferência como já confirmada&#10;        TransferenciaModel transferencia = new TransferenciaModel();&#10;        transferencia.setEstoque(estoque);&#10;        transferencia.setQuantidadeTransferida(quantidadeTransferida);&#10;        transferencia.setSetor(setorUpper);&#10;        transferencia.setUltimaMovimentacao(LocalDateTime.now().truncatedTo(ChronoUnit.SECONDS));&#10;        transferencia.setTipoMaterial(tipoMaterial);&#10;        transferencia.setConfirmada(true);&#10;&#10;        // Salvar a transferência&#10;        TransferenciaModel salvo = transferenciaRepository.save(transferencia);&#10;&#10;        // Retornar DTO&#10;        return TransferenciaMapper.toTransferenciaDto(salvo);&#10;    }&#10;&#10;    // Confirmar uma transferência pendente (caso ainda exista alguma pendente)&#10;    @Transactional&#10;    public TransferenciaDto confirmarTransferencia(Integer transferenciaId) {&#10;        TransferenciaModel transferencia = transferenciaRepository.findById(transferenciaId)&#10;                .orElseThrow(() -&gt; new RecursoNaoEncontradoException(&quot;Transferência não encontrada&quot;));&#10;&#10;        if (transferencia.getConfirmada() != null &amp;&amp; transferencia.getConfirmada()) {&#10;            throw new RequisicaoInvalidaException(&quot;Transferência já foi confirmada&quot;);&#10;        }&#10;&#10;        // Buscar o estoque DIRETAMENTE do banco para garantir dados atualizados&#10;        EstoqueModel estoque = estoqueRepository.findById(transferencia.getEstoque().getId())&#10;                .orElseThrow(() -&gt; new RecursoNaoEncontradoException(&quot;Estoque não encontrado&quot;));&#10;&#10;        Integer quantidadeTransferida = transferencia.getQuantidadeTransferida();&#10;        Integer quantidadeAtual = estoque.getQuantidadeAtual() != null ? estoque.getQuantidadeAtual() : 0;&#10;&#10;        // Verificar se ainda há quantidade suficiente no estoque&#10;        if (quantidadeAtual &lt; quantidadeTransferida) {&#10;            throw new RequisicaoInvalidaException(&quot;Quantidade insuficiente no estoque para confirmar&quot;);&#10;        }&#10;&#10;        // Subtrair da quantidade atual do estoque&#10;        estoque.setQuantidadeAtual(quantidadeAtual - quantidadeTransferida);&#10;&#10;        // Adicionar ao setor correto (G1, G2, G3 ou G4)&#10;        String setor = transferencia.getSetor().toUpperCase();&#10;        switch (setor) {&#10;            case &quot;G1&quot;:&#10;                Integer g1Atual = estoque.getG1() != null ? estoque.getG1() : 0;&#10;                estoque.setG1(g1Atual + quantidadeTransferida);&#10;                break;&#10;            case &quot;G2&quot;:&#10;                Integer g2Atual = estoque.getG2() != null ? estoque.getG2() : 0;&#10;                estoque.setG2(g2Atual + quantidadeTransferida);&#10;                break;&#10;            case &quot;G3&quot;:&#10;                Integer g3Atual = estoque.getG3() != null ? estoque.getG3() : 0;&#10;                estoque.setG3(g3Atual + quantidadeTransferida);&#10;                break;&#10;            case &quot;G4&quot;:&#10;                Integer g4Atual = estoque.getG4() != null ? estoque.getG4() : 0;&#10;                estoque.setG4(g4Atual + quantidadeTransferida);&#10;                break;&#10;            default:&#10;                throw new RequisicaoInvalidaException(&quot;Setor inválido: &quot; + setor);&#10;        }&#10;&#10;        estoque.setUltimaMovimentacao(LocalDateTime.now().truncatedTo(ChronoUnit.SECONDS));&#10;        estoqueRepository.save(estoque);&#10;&#10;        // Marcar transferência como confirmada&#10;        transferencia.setConfirmada(true);&#10;        transferencia.setUltimaMovimentacao(LocalDateTime.now().truncatedTo(ChronoUnit.SECONDS));&#10;        TransferenciaModel salvo = transferenciaRepository.save(transferencia);&#10;&#10;        return TransferenciaMapper.toTransferenciaDto(salvo);&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>